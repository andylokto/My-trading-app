<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MIM DRIVE & VCP 系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: -apple-system, sans-serif; }
        .drive-checkbox:checked + label { background-color: #3b82f6; border-color: #3b82f6; color: white; font-weight: bold; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-blue-500 italic uppercase">MIM Drive <span class="text-white">V2</span></h1>
            <div class="bg-slate-800 p-2 rounded-xl border border-slate-700">
                <span class="text-[9px] text-gray-400 block uppercase font-bold text-center mb-1">Exposure Level</span>
                <select id="exposureLevel" onchange="calculate()" class="bg-slate-900 text-xs p-1 rounded font-bold text-blue-400">
                    <option value="0.5">新手 0.5%</option>
                    <option value="1.0" selected>標準 1.0%</option>
                    <option value="2.0">進取 2.0%</option>
                    <option value="2.5">極限 2.5%</option>
                </select>
            </div>
        </header>

        <section class="bg-slate-800/50 p-5 rounded-3xl mb-6 border border-slate-700">
            <p class="text-[10px] font-bold text-blue-400 mb-3 uppercase tracking-widest">VCP 形態診斷 (由左至右收縮 %)</p>
            <div class="grid grid-cols-4 gap-3">
                <div>
                    <input type="number" id="vcp1" placeholder="1st %" oninput="checkVCP()" class="w-full bg-slate-900 p-3 rounded-xl border border-slate-700 text-center font-bold">
                </div>
                <div>
                    <input type="number" id="vcp2" placeholder="2nd %" oninput="checkVCP()" class="w-full bg-slate-900 p-3 rounded-xl border border-slate-700 text-center font-bold">
                </div>
                <div>
                    <input type="number" id="vcp3" placeholder="3rd %" oninput="checkVCP()" class="w-full bg-slate-900 p-3 rounded-xl border border-slate-700 text-center font-bold">
                </div>
                <div class="flex items-center justify-center">
                    <span id="vcpStatus" class="text-[10px] font-black px-2 py-1 rounded bg-slate-700 text-gray-500 italic">WAITING</span>
                </div>
            </div>
            <p id="vcpHint" class="text-[10px] text-gray-500 mt-3 italic text-center">請輸入收縮百分比，系統將判斷是否符合收窄準則。</p>
        </section>

        <section class="bg-slate-800/50 p-4 rounded-2xl mb-6 border border-slate-700">
            <div class="grid grid-cols-5 gap-2">
                <div class="relative"><input type="checkbox" id="d" class="drive-checkbox hidden"><label for="d" class="block text-center p-3 rounded-xl border border-slate-600 text-xs cursor-pointer transition">D</label></div>
                <div class="relative"><input type="checkbox" id="r" class="drive-checkbox hidden"><label for="r" class="block text-center p-3 rounded-xl border border-slate-600 text-xs cursor-pointer transition">R</label></div>
                <div class="relative"><input type="checkbox" id="i" class="drive-checkbox hidden"><label for="i" class="block text-center p-3 rounded-xl border border-slate-600 text-xs cursor-pointer transition">I</label></div>
                <div class="relative"><input type="checkbox" id="v" class="drive-checkbox hidden"><label for="v" class="block text-center p-3 rounded-xl border border-slate-600 text-xs cursor-pointer transition">V</label></div>
                <div class="relative"><input type="checkbox" id="e" class="drive-checkbox hidden"><label for="e" class="block text-center p-3 rounded-xl border border-slate-600 text-xs cursor-pointer transition">E</label></div>
            </div>
        </section>

        <section class="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl mb-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" id="symbol" placeholder="股票代碼" class="bg-slate-800 p-4 rounded-2xl border border-slate-700 font-black uppercase text-xl text-blue-400">
                <input type="number" id="capital" value="10000" oninput="calculate()" class="bg-slate-800 p-4 rounded-2xl border border-slate-700 font-bold text-xl">
            </div>
            <div class="grid grid-cols-3 gap-3 mb-6">
                <input type="number" id="entry" placeholder="買入價" oninput="calculate()" class="bg-slate-800 p-4 rounded-2xl border border-slate-700 text-sm">
                <input type="number" id="sl" placeholder="止損價" oninput="calculate()" class="bg-slate-800 p-4 rounded-2xl border border-slate-700 text-sm text-red-400 font-bold">
                <input type="number" id="tp" placeholder="目標價" oninput="calculate()" class="bg-slate-800 p-4 rounded-2xl border border-slate-700 text-sm text-green-400 font-bold">
            </div>

            <div class="bg-blue-600/10 p-5 rounded-3xl flex justify-between items-center border border-blue-500/20 mb-4">
                <div class="text-center flex-1">
                    <p class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">建議股數</p>
                    <p id="qty" class="text-4xl font-black">0</p>
                </div>
                <div class="w-px h-10 bg-slate-700 mx-4"></div>
                <div class="text-center flex-1">
                    <p class="text-[9px] text-blue-400 font-bold uppercase tracking-widest">預期 RRR</p>
                    <p id="rrr" class="text-3xl font-black">1 : 0.0</p>
                </div>
            </div>
            
            <button onclick="saveTrade()" class="w-full bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">儲存 DRIVE 交易計畫</button>
        </section>

        <div id="logs" class="space-y-3"></div>
    </div>

    <script>
        function checkVCP() {
            const v1 = parseFloat(document.getElementById('vcp1').value) || 0;
            const v2 = parseFloat(document.getElementById('vcp2').value) || 0;
            const v3 = parseFloat(document.getElementById('vcp3').value) || 0;
            const status = document.getElementById('vcpStatus');
            const hint = document.getElementById('vcpHint');

            if (v1 > 0 && v2 > 0) {
                if (v2 < v1 && (v3 === 0 || v3 < v2)) {
                    status.innerText = "VALID VCP";
                    status.className = "text-[10px] font-black px-2 py-1 rounded bg-green-500 text-white";
                    hint.innerText = "符合收縮準則：波動正在由左至右收窄。";
                    document.getElementById('v').checked = true; // 自動勾選 DRIVE 中的 V
                } else {
                    status.innerText = "INVALID";
                    status.className = "text-[10px] font-black px-2 py-1 rounded bg-red-500 text-white";
                    hint.innerText = "警告：波動未有效收窄，可能不符合 VCP 形態。";
                    document.getElementById('v').checked = false;
                }
            }
        }

        function calculate() {
            const cap = parseFloat(document.getElementById('capital').value) || 0;
            const riskP = parseFloat(document.getElementById('exposureLevel').value);
            const entry = parseFloat(document.getElementById('entry').value) || 0;
            const sl = parseFloat(document.getElementById('sl').value) || 0;
            const tp = parseFloat(document.getElementById('tp').value) || 0;

            const riskAmt = cap * (riskP / 100);
            
            if (entry && sl && entry !== sl) {
                const perRisk = Math.abs(entry - sl);
                const qty = Math.floor(riskAmt / perRisk);
                document.getElementById('qty').innerText = qty;

                if (tp) {
                    const rValue = (Math.abs(tp - entry) / perRisk).toFixed(2);
                    const rDisplay = document.getElementById('rrr');
                    rDisplay.innerText = `1 : ${rValue}`;
                    rDisplay.style.color = rValue >= 2.5 ? "#4ade80" : "#f87171";
                }
            }
        }

        function saveTrade() {
            const sym = document.getElementById('symbol').value.toUpperCase();
            if(!sym) return alert("請輸入股票代碼");

            const driveScore = ['d','r','i','v','e'].filter(id => document.getElementById(id).checked).length;
            const trade = {
                id: Date.now(),
                sym,
                rrr: document.getElementById('rrr').innerText,
                qty: document.getElementById('qty').innerText,
                score: driveScore,
                vcp: `${document.getElementById('vcp1').value}%-${document.getElementById('vcp2').value}%`,
                date: new Date().toLocaleDateString()
            };

            let logs = JSON.parse(localStorage.getItem('mim_logs_v2') || '[]');
            logs.unshift(trade);
            localStorage.setItem('mim_logs_v2', JSON.stringify(logs));
            display();
        }

        function display() {
            const logs = JSON.parse(localStorage.getItem('mim_logs_v2') || '[]');
            const list = document.getElementById('logs');
            list.innerHTML = '<h2 class="text-xs font-bold text-gray-500 mb-4 uppercase tracking-widest">最近交易日誌</h2>';
            
            logs.forEach(l => {
                list.innerHTML += `
                    <div class="bg-slate-800/80 p-5 rounded-3xl border border-slate-700 flex justify-between items-center mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[9px] bg-blue-600 px-2 py-0.5 rounded font-black">${l.date}</span>
                                <span class="text-xl font-black text-white">${l.sym}</span>
                            </div>
                            <p class="text-xs text-gray-400 font-bold">DRIVE: ${l.score}/5 | 股數: ${l.qty}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-black ${parseFloat(l.rrr.split(':')[1]) >= 2.5 ? 'text-green-400' : 'text-gray-400'}">${l.rrr}</p>
                            <button onclick="deleteLog(${l.id})" class="text-[9px] text-red-500 font-bold mt-1 uppercase">Delete</button>
                        </div>
                    </div>`;
            });
        }

        function deleteLog(id) {
            if(!confirm("確定刪除此計畫？")) return;
            let logs = JSON.parse(localStorage.getItem('mim_logs_v2') || '[]');
            localStorage.setItem('mim_logs_v2', JSON.stringify(logs.filter(l => l.id !== id)));
            display();
        }

        window.onload = display;
    </script>
</body>
</html>
